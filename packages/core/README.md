# @draw-poster/core

é«˜æ€§èƒ½çš„ Canvas æµ·æŠ¥ç»˜åˆ¶åº“ï¼Œæä¾›å®Œæ•´çš„å›¾å±‚ç³»ç»Ÿã€é«˜çº§ç»˜åˆ¶åŠŸèƒ½å’Œæ¨¡æ¿åŒ–æ¸²æŸ“èƒ½åŠ›ã€‚

## ç‰¹æ€§

### ğŸ¨ æ ¸å¿ƒç»˜åˆ¶åŠŸèƒ½
- **ç”»å¸ƒç®¡ç†**ï¼šæ”¯æŒç”»å¸ƒå°ºå¯¸è®¾ç½®ã€æ¸…å±ã€ä¿å­˜/æ¢å¤ã€å˜æ¢ï¼ˆå¹³ç§»/æ—‹è½¬/ç¼©æ”¾ï¼‰
- **åŸºç¡€å›¾å½¢**ï¼šçŸ©å½¢ã€åœ†å½¢ã€çº¿æ¡ã€å¤šè¾¹å½¢ï¼Œæ”¯æŒå¡«å……ã€æè¾¹ã€é˜´å½±ã€çº¿å‹é…ç½®
- **æ–‡æœ¬ç»˜åˆ¶**ï¼šå®Œæ•´çš„å­—ä½“æ ·å¼æ”¯æŒã€æ–‡æœ¬å¯¹é½ã€è‡ªåŠ¨æ¢è¡Œã€æœ€å¤§è¡Œæ•°é™åˆ¶ã€æ–‡æœ¬çœç•¥
- **å›¾åƒå¤„ç†**ï¼šå›¾åƒåŠ è½½ã€è£å‰ªã€åœ†è§’ã€æ—‹è½¬ã€é€æ˜åº¦æ§åˆ¶
- **äºŒç»´ç ç”Ÿæˆ**ï¼šé›†æˆ qrcode åº“ï¼Œæ”¯æŒè‡ªå®šä¹‰æ ·å¼å’Œçº é”™ç­‰çº§

### ğŸ—ï¸ é«˜çº§ç‰¹æ€§
- **å›¾å±‚ç³»ç»Ÿ**ï¼šå®Œæ•´çš„å›¾å±‚ç®¡ç†ï¼ˆæ·»åŠ /åˆ é™¤/è·å–ï¼‰ï¼Œæ”¯æŒ zIndex æ’åºå’Œå›¾å±‚æ˜¾éšæ§åˆ¶
- **é«˜çº§å¡«å……**ï¼šçº¿æ€§æ¸å˜ã€å¾„å‘æ¸å˜ã€å›¾æ¡ˆå¡«å……
- **å¯Œæ–‡æœ¬èƒ½åŠ›**ï¼šæ”¯æŒå¤šæ ·å¼æ–‡æœ¬ç‰‡æ®µï¼ˆTextSpanï¼‰ã€å­—è·æ§åˆ¶ï¼ˆletterSpacingï¼‰ã€å­—ä½“åŠ¨æ€åŠ è½½
- **è’™ç‰ˆç³»ç»Ÿ**ï¼šæ”¯æŒä»»æ„å›¾å±‚ä½œä¸ºè’™ç‰ˆè¿›è¡Œè£å‰ª
- **é«˜çº§å›¾åƒå¤„ç†**ï¼šæ»¤é•œã€æ··åˆæ¨¡å¼ã€ä¹å®«æ ¼æ‹‰ä¼¸ï¼ˆscale9Gridï¼‰
- **å¤æ‚æ–‡æœ¬æ’ç‰ˆ**ï¼šç«–æ’æ–‡æœ¬ã€å¼§çº¿è·¯å¾„æ–‡å­—ï¼ˆdrawTextOnArcï¼‰ã€æ¨ªæ’å­—è·ç²¾ç¡®æ§åˆ¶

### ğŸ”Œ æ‰©å±•ä¸è°ƒè¯•
- **æ’ä»¶ç³»ç»Ÿ**ï¼šæä¾› onInitã€beforeDrawã€afterDraw ç”Ÿå‘½å‘¨æœŸé’©å­
- **è°ƒè¯•æ¨¡å¼**ï¼šå¯è§†åŒ–ç½‘æ ¼ã€åŸºå‡†çº¿ã€å›¾å±‚è¾¹ç•Œæ¡†ï¼Œæ”¯æŒç»†ç²’åº¦æ§åˆ¶
- **æ¨¡æ¿ç³»ç»Ÿ**ï¼šTemplateRegistry æ”¯æŒæ³¨å†Œ/æ³¨é”€å¯å¤ç”¨å›¾å±‚æ¨¡æ¿
- **æ€§èƒ½ç»Ÿè®¡**ï¼šæ¸²æŸ“/åŠ è½½è€—æ—¶è¿½è¸ªã€å›¾å±‚è®¡æ•°ç»Ÿè®¡

### ğŸ“¦ å¯¼å‡ºä¸èµ„æº
- **å¯¼å‡ºæ ¼å¼**ï¼šDataURLã€Blobã€ImageData
- **èµ„æºç®¡ç†**ï¼šResourceManager æä¾›èµ„æºé¢„åŠ è½½ä¸ç¼“å­˜
- **å¤šç¯å¢ƒæ”¯æŒ**ï¼šæ”¯æŒç¦»å±æ¸²æŸ“ï¼ˆOffscreenCanvasï¼‰

## å®‰è£…

```bash
pnpm add @draw-poster/core
```

## å¿«é€Ÿå¼€å§‹

### åŸºç¡€ä½¿ç”¨

```ts
import createDrawPoster from '@draw-poster/core';

// è·å– Canvas ä¸Šä¸‹æ–‡
const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const ctx = canvas.getContext('2d')!;

// åˆ›å»º DrawPoster å®ä¾‹
const poster = createDrawPoster(ctx, {
  ratio: 1,        // åƒç´ æ¯”ä¾‹
  debug: false,    // è°ƒè¯•æ¨¡å¼
});

// è®¾ç½®ç”»å¸ƒå¤§å°
poster.setCanvasSize(800, 600);

// ç»˜åˆ¶çŸ©å½¢
poster.drawRect({
  x: 10,
  y: 10,
  width: 100,
  height: 50,
  fillStyle: '#FF0000',
});

// ç»˜åˆ¶æ–‡æœ¬
poster.drawText({
  x: 120,
  y: 30,
  text: 'Hello World',
  fontSize: 24,
  fillStyle: '#000000',
});

// å¯¼å‡º
const dataUrl = await poster.exportDataURL();
```

### å›¾å±‚æ¨¡å¼ï¼ˆæ¨èï¼‰

```ts
const poster = createDrawPoster(ctx);

// æ·»åŠ å›¾å±‚
poster.addLayer({
  type: 'rect',
  x: 10,
  y: 10,
  width: 100,
  height: 50,
  fillStyle: '#FF0000',
  zIndex: 1,
});

poster.addLayer({
  type: 'text',
  x: 120,
  y: 30,
  text: 'Hello',
  fontSize: 24,
  zIndex: 2,
});

// æ¸²æŸ“æ‰€æœ‰å›¾å±‚
await poster.render();
```

## API æ–‡æ¡£

### DrawPoster å®ä¾‹æ–¹æ³•

#### ç”»å¸ƒæ“ä½œ
- `setCanvasSize(width: number, height: number): void` - è®¾ç½®ç”»å¸ƒå¤§å°
- `clearCanvas(): void` - æ¸…ç©ºç”»å¸ƒ
- `save(): void` - ä¿å­˜ç”»å¸ƒçŠ¶æ€
- `restore(): void` - æ¢å¤ç”»å¸ƒçŠ¶æ€

#### å›¾å½¢ç»˜åˆ¶ï¼ˆåŒæ­¥ï¼‰
- `drawRect(options: RectOptions): void` - ç»˜åˆ¶çŸ©å½¢
- `drawCircle(options: CircleOptions): void` - ç»˜åˆ¶åœ†å½¢
- `drawLine(options: LineOptions): void` - ç»˜åˆ¶çº¿æ¡
- `drawPolygon(options: PolygonOptions): void` - ç»˜åˆ¶å¤šè¾¹å½¢
- `drawText(options: TextOptions): void` - ç»˜åˆ¶æ–‡æœ¬

#### å›¾åƒä¸äºŒç»´ç 
- `drawImage(options: ImageOptions): Promise<void>` - ç»˜åˆ¶å›¾åƒ
- `drawQRCode(options: QRCodeOptions): void` - ç»˜åˆ¶äºŒç»´ç 

#### å¯Œæ–‡æœ¬
- `drawRichText(options: any): Promise<void>` - ç»˜åˆ¶å¯Œæ–‡æœ¬

#### å›¾å±‚æ“ä½œ
- `addLayer(layer: Layer): string` - æ·»åŠ å›¾å±‚ï¼Œè¿”å›å›¾å±‚ ID
- `removeLayer(layerId: string): void` - åˆ é™¤å›¾å±‚
- `getLayer(layerId: string): Layer | undefined` - è·å–å›¾å±‚
- `getLayers(): Layer[]` - è·å–æ‰€æœ‰å›¾å±‚
- `render(): Promise<void>` - æ¸²æŸ“æ‰€æœ‰å›¾å±‚

#### å˜æ¢
- `transform(options: TransformOptions): void` - åº”ç”¨å˜æ¢ï¼ˆå¹³ç§»ã€æ—‹è½¬ã€ç¼©æ”¾ï¼‰
- `moveLayer(layerId: string, dx: number, dy: number): void` - ç§»åŠ¨å›¾å±‚ä½ç½®

#### å¸ƒå±€
- `alignLayers(layerIds: string[], align: AlignType): void` - å¯¹é½å›¾å±‚
- `distributeLayers(layerIds: string[], distribute: DistributeType): void` - åˆ†å¸ƒå›¾å±‚

#### å¯¼å‡º
- `exportDataURL(type?: string, quality?: number): Promise<string>` - å¯¼å‡ºä¸º DataURL
- `exportBlob(type?: string, quality?: number): Promise<Blob>` - å¯¼å‡ºä¸º Blob
- `exportImageData(): ImageData` - å¯¼å‡ºä¸º ImageData

#### è°ƒè¯•
- `addDebugGuides(options: GuideOptions[]): void` - æ·»åŠ åŸºå‡†çº¿
- `getPerformanceStats(): PerformanceStats` - è·å–æ€§èƒ½ç»Ÿè®¡

### å›¾å±‚ç±»å‹

æ‰€æœ‰å›¾å±‚éƒ½æ”¯æŒä»¥ä¸‹åŸºç¡€å±æ€§ï¼š
- `type: string` - å›¾å±‚ç±»å‹ï¼ˆ'rect', 'circle', 'text' ç­‰ï¼‰
- `zIndex?: number` - å †å é¡ºåºï¼ˆé»˜è®¤ 0ï¼‰
- `visible?: boolean` - æ˜¯å¦æ˜¾ç¤ºï¼ˆé»˜è®¤ trueï¼‰
- `mask?: string` - è’™ç‰ˆå›¾å±‚ ID
- `filter?: string` - CSS æ»¤é•œ
- `globalCompositeOperation?: string` - æ··åˆæ¨¡å¼

#### RectLayer
```ts
{
  type: 'rect',
  x: number,
  y: number,
  width: number,
  height: number,
  fillStyle?: FillStyle,
  strokeStyle?: FillStyle,
  lineWidth?: number,
  // ... æ›´å¤šæ ·å¼é€‰é¡¹
}
```

#### CircleLayer
```ts
{
  type: 'circle',
  x: number,
  y: number,
  radius: number,
  fillStyle?: FillStyle,
  // ... æ›´å¤šæ ·å¼é€‰é¡¹
}
```

#### TextLayer
```ts
{
  type: 'text',
  x: number,
  y: number,
  text?: string,
  spans?: TextSpan[],       // å¯Œæ–‡æœ¬
  fontSize?: number,
  fontFamily?: string,
  direction?: 'horizontal' | 'vertical',
  // ... æ›´å¤šæ–‡æœ¬é€‰é¡¹
}
```

#### ImageLayer
```ts
{
  type: 'image',
  x: number,
  y: number,
  src: string | HTMLImageElement,
  width?: number,
  height?: number,
  // ... æ›´å¤šå›¾åƒé€‰é¡¹
}
```

#### QRCodeLayer
```ts
{
  type: 'qrcode',
  x: number,
  y: number,
  text: string,
  size?: number,
  fillStyle?: string,
  // ... æ›´å¤šäºŒç»´ç é€‰é¡¹
}
```

## é«˜çº§ç”¨æ³•

### æ¸å˜å¡«å……

```ts
// çº¿æ€§æ¸å˜
poster.drawRect({
  x: 10,
  y: 10,
  width: 100,
  height: 50,
  fillStyle: {
    type: 'linear',
    x0: 10,
    y0: 10,
    x1: 110,
    y1: 60,
    stops: [
      { offset: 0, color: '#FF0000' },
      { offset: 1, color: '#0000FF' },
    ],
  },
});

// å¾„å‘æ¸å˜
poster.drawCircle({
  x: 50,
  y: 50,
  radius: 30,
  fillStyle: {
    type: 'radial',
    x0: 40,
    y0: 40,
    r0: 0,
    x1: 50,
    y1: 50,
    r1: 30,
    stops: [
      { offset: 0, color: '#FFFFFF' },
      { offset: 1, color: '#000000' },
    ],
  },
});
```

### å¯Œæ–‡æœ¬æ¸²æŸ“

```ts
poster.addLayer({
  type: 'text',
  x: 10,
  y: 10,
  spans: [
    { text: 'Hello', fontSize: 20, fillStyle: '#FF0000' },
    { text: ' World', fontSize: 20, fillStyle: '#0000FF' },
  ],
});

await poster.render();
```

### æ¨¡æ¿ç³»ç»Ÿ

```ts
import { TemplateRegistry } from '@draw-poster/core';

const registry = new TemplateRegistry();

// æ³¨å†Œæ¨¡æ¿
registry.register('badge', (data) => [
  {
    type: 'rect',
    x: 0,
    y: 0,
    width: 80,
    height: 30,
    fillStyle: data.color,
  },
  {
    type: 'text',
    x: 40,
    y: 15,
    text: data.label,
    textAlign: 'center',
    verticalAlign: 'middle',
  },
]);

// ä½¿ç”¨æ¨¡æ¿
const layers = registry.create('badge', {
  color: '#FF0000',
  label: 'New',
});

poster.addLayers(layers);
await poster.render();
```

### è°ƒè¯•æ¨¡å¼

```ts
const poster = createDrawPoster(ctx, {
  debug: true,  // å¯ç”¨è°ƒè¯•
});

poster.addLayer({
  type: 'rect',
  x: 10,
  y: 10,
  width: 100,
  height: 50,
  fillStyle: '#FF0000',
});

// æ·»åŠ åŸºå‡†çº¿
poster.addDebugGuides([
  { type: 'horizontal', position: 10 },
  { type: 'vertical', position: 10 },
]);

await poster.render();  // ä¼šè‡ªåŠ¨æ˜¾ç¤ºè¾¹ç•Œæ¡†å’ŒåŸºå‡†çº¿
```

### æ’ä»¶ç³»ç»Ÿ

```ts
const myPlugin = {
  onInit(ctx, options) {
    console.log('åˆå§‹åŒ–');
  },
  beforeDraw(layer) {
    console.log('ç»˜åˆ¶å‰', layer);
  },
  afterDraw(layer) {
    console.log('ç»˜åˆ¶å', layer);
  },
};

const poster = createDrawPoster(ctx, {
  plugins: [myPlugin],
});
```

## æ€§èƒ½ä¼˜åŒ–

### ResourceManager èµ„æºç¼“å­˜

```ts
import { ResourceManager } from '@draw-poster/core';

const resourceManager = new ResourceManager();

// é¢„åŠ è½½èµ„æº
await resourceManager.loadImage('https://example.com/image.png');

const poster = createDrawPoster(ctx, {
  resourceManager,
});

// å›¾ç‰‡ä¼šä»ç¼“å­˜ä¸­è¯»å–
await poster.drawImage({
  src: 'https://example.com/image.png',
  x: 10,
  y: 10,
});
```

### ç¦»å±æ¸²æŸ“

åœ¨ Node.js ç¯å¢ƒä¸­ä½¿ç”¨ OffscreenCanvasï¼š

```ts
import { createCanvas } from 'canvas';  // or use polyfill

const offscreenCanvas = new OffscreenCanvas(800, 600);
const ctx = offscreenCanvas.getContext('2d')!;

const poster = createDrawPoster(ctx);
// ... ç»˜åˆ¶å†…å®¹
```

## æµ‹è¯•

```bash
pnpm test
```

æ”¯æŒçš„æµ‹è¯•è¦†ç›–ï¼š
- æ ¸å¿ƒç»˜åˆ¶åŠŸèƒ½
- å¯¼å‡ºèƒ½åŠ›
- å›¾å±‚ç³»ç»Ÿ
- å¯Œæ–‡æœ¬æ¸²æŸ“
- é«˜çº§ç‰¹æ€§

## æµè§ˆå™¨æ”¯æŒ

- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## è®¸å¯è¯

ISC
